{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upc-scan me-2"></i>Barcode Scanner
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Pilih Metode -->
                    <div class="mb-3">
                        <label class="form-label">Pilih Metode Scan:</label>
                        <select id="scannerType" class="form-select mb-3" onchange="changeScannerType()">
                            <option value="html5">HTML5 Scanner (Rekomendasi)</option>
                            <option value="manual">Manual Input</option>
                        </select>
                    </div>
                    
                    <!-- HTML5 Scanner Area -->
                    <div id="html5ScannerArea">
                        <div id="reader" class="border rounded mb-3" style="width: 100%; height: 400px; background: #000;"></div>
                        
                        <div class="text-center">
                            <button id="startBtn" class="btn btn-success" onclick="startScanner()">
                                <i class="bi bi-play-circle"></i> Mulai Scan
                            </button>
                            <button id="stopBtn" class="btn btn-danger" onclick="stopScanner()" disabled>
                                <i class="bi bi-stop-circle"></i> Stop Scan
                            </button>
                        </div>
                    </div>
                    
                    <!-- Manual Input Area -->
                    <div id="manualInputArea" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Masukkan Kode Barcode:</label>
                            <input type="text" id="manualBarcode" class="form-control" 
                                   placeholder="Contoh: 1, 5, 1001..."
                                   onkeypress="if(event.key === 'Enter') manualScan()">
                        </div>
                        <button class="btn btn-primary w-100" onclick="manualScan()">
                            <i class="bi bi-search"></i> Cari Produk
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Hasil Scan -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Hasil Scan
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scanResult">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-upc-scan fs-1 d-block mb-2"></i>
                            Silakan scan barcode atau ketik manual
                        </div>
                    </div>
                    
                    <div class="mt-3" id="productInfo" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load HTML5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
// ============================================
// SIMPLE HTML5 QR CODE SCANNER
// ============================================

let html5QrCode = null;

// Mulai scanner
function startScanner() {
    try {
        // Stop scanner sebelumnya
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop();
        }
        
        // Buat instance baru
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 500, height: 500 },  // DARI 250x250 JADI 500x500 (2x lipat!)
            rememberLastUsedCamera: true
        };
        
        // Mulai scanning dengan kamera belakang
        html5QrCode.start(
            { facingMode: "environment" },  // Kamera belakang
            config,
            onScanSuccess,
            onScanError
        ).then(() => {
            console.log('✅ Scanner started');
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }).catch(err => {
            console.error('❌ Failed to start:', err);
            alert('Gagal memulai scanner: ' + err.message);
            
            // Fallback ke manual input
            document.getElementById('scannerType').value = 'manual';
            changeScannerType();
        });
        
    } catch (error) {
        console.error('Error:', error);
        alert('Scanner error: ' + error.message);
    }
}

// Stop scanner
function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
            console.log('Scanner stopped');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }).catch(err => {
            console.error('Failed to stop:', err);
        });
    }
}

// Saat scan berhasil
function onScanSuccess(decodedText, decodedResult) {
    console.log('Scan result:', decodedText);
    
    // Stop scanner sementara
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.pause();
    }
    
    // Tampilkan hasil
    document.getElementById('scanResult').innerHTML = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Berhasil scan!</strong> Kode: ${decodedText}
        </div>
    `;
    
    // Cari produk
    findProductByBarcode(decodedText);
    
    // Resume setelah 3 detik
    setTimeout(() => {
        if (html5QrCode) {
            html5QrCode.resume();
        }
    }, 3000);
}

// Saat scan error
function onScanError(error) {
    // Biarkan, scanner akan terus mencoba
    // console.log('Scan error:', error);
}

// Ganti tipe scanner
function changeScannerType() {
    const type = document.getElementById('scannerType').value;
    
    if (type === 'html5') {
        document.getElementById('html5ScannerArea').style.display = 'block';
        document.getElementById('manualInputArea').style.display = 'none';
        stopScanner();
    } else {
        document.getElementById('html5ScannerArea').style.display = 'none';
        document.getElementById('manualInputArea').style.display = 'block';
        stopScanner();
    }
}

// Manual scan
function manualScan() {
    const barcode = document.getElementById('manualBarcode').value.trim();
    if (!barcode) {
        alert('Masukkan kode barcode!');
        return;
    }
    
    document.getElementById('scanResult').innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-search me-2"></i>
            Mencari produk: ${barcode}...
        </div>
    `;
    
    findProductByBarcode(barcode);
    document.getElementById('manualBarcode').value = '';
}

// Cari produk
async function findProductByBarcode(barcode) {
    try {
        const response = await fetch('/api/find_product_by_barcode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ barcode: barcode })
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayProductResult(result.product);
        } else {
            document.getElementById('scanResult').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${result.message}
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('scanResult').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    }
}

// Tampilkan hasil produk
function displayProductResult(product) {
    const safeName = (product.Name_product || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    document.getElementById('productInfo').style.display = 'block';
    document.getElementById('productInfo').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">${product.Name_product || product.name}</h6>
                <p class="card-text">
                    <strong>SKU:</strong> ${product.no_SKU || product.sku}<br>
                    <strong>Harga:</strong> Rp${parseInt(product.Price || product.price).toLocaleString()}<br>
                    <strong>Stok:</strong> ${product.stok || 0} pcs<br>
                    <strong>Tipe:</strong> <span class="badge ${product.type === 'lelang' ? 'bg-warning' : 'bg-info'}">${product.type || 'biasa'}</span>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="addToCartFromScanner('${product.no_SKU || product.sku}', '${safeName}', ${product.Price || product.price}, '${product.type || 'biasa'}')">
                        <i class="bi bi-cart-plus"></i> Tambah ke Keranjang
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Tambah ke cart
function addToCartFromScanner(sku, name, price, type) {
    try {
        let cart = JSON.parse(localStorage.getItem('cartItems') || '[]');
        
        const existingItem = cart.find(item => 
            String(item.sku) === String(sku) && item.mode === type
        );
        
        if (existingItem) {
            existingItem.qty += 1;
            existingItem.subtotal = existingItem.qty * existingItem.price;
        } else {
            cart.push({
                sku: sku,
                name: name,
                price: parseFloat(price),
                qty: 1,
                subtotal: parseFloat(price),
                mode: type
            });
        }
        
        localStorage.setItem('cartItems', JSON.stringify(cart));
        
        alert(`✅ ${name} berhasil ditambahkan ke keranjang!`);
        
        if (confirm('Buka halaman kasir?')) {
            window.location.href = '/kasir';
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Gagal menambahkan ke keranjang');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Scanner page loaded');
    
    // Set default
    document.getElementById('scannerType').value = 'html5';
    changeScannerType();
});
</script>
{% endblock %}