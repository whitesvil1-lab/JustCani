{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Kamera Scanner -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upc-scan me-2"></i>Barcode Scanner
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Pilihan Kamera -->
                    <div class="mb-3">
                        <label class="form-label">Pilih Kamera:</label>
                        <select id="cameraSelect" class="form-select mb-3">
                            <option value="">Loading kamera...</option>
                        </select>
                    </div>
                    
                    <!-- Area Kamera -->
                    <div class="text-center">
                        <div class="border rounded overflow-hidden position-relative" id="scannerContainer">
                            <video id="scannerVideo" class="w-100" playsinline autoplay muted></video>
                            <div class="scanner-overlay"></div>
                            <div class="scanner-guide"></div>
                        </div>
                        
                        <!-- Kontrol Kamera -->
                        <div class="mt-3">
                            <button id="startButton" class="btn btn-success" onclick="startScanner()">
                                <i class="bi bi-play-circle"></i> Mulai Scan
                            </button>
                            <button id="stopButton" class="btn btn-danger" onclick="stopScanner()" disabled>
                                <i class="bi bi-stop-circle"></i> Stop Scan
                            </button>
                            <button id="captureButton" class="btn btn-primary" onclick="captureFrame()" disabled>
                                <i class="bi bi-camera"></i> Capture
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Manual Input (Fallback) -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-keyboard me-2"></i>Manual Input
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Masukkan Kode Barcode:</label>
                        <input type="text" id="manualBarcode" class="form-control" 
                               placeholder="Ketik atau scan barcode..."
                               onkeypress="if(event.key === 'Enter') manualScan()">
                    </div>
                    <button class="btn btn-primary w-100" onclick="manualScan()">
                        <i class="bi bi-search"></i> Cari Produk
                    </button>
                    
                    <hr>
                    
                    <!-- Mode Scanner -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoModeSwitch" checked>
                        <label class="form-check-label" for="autoModeSwitch">
                            Auto-detect barcode
                        </label>
                    </div>
                    
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i>
                        Letakkan barcode di dalam kotak scanner. Sistem akan otomatis mendeteksi.
                    </div>
                </div>
            </div>
            
            <!-- Hasil Scan -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Hasil Scan
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scanResult">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-upc-scan fs-1 d-block mb-2"></i>
                            Belum ada hasil scan
                        </div>
                    </div>
                    
                    <div class="mt-3" id="productInfo" style="display: none;">
                        <!-- Info produk akan muncul di sini -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
// ============================================
// BARCODE SCANNER FUNCTIONS
// ============================================

let videoStream = null;
let scanInterval = null;
let currentCameraId = null;

// Daftar kamera yang tersedia
async function loadCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        const select = document.getElementById('cameraSelect');
        select.innerHTML = '<option value="">Pilih Kamera...</option>';
        
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = device.label || `Kamera ${index + 1}`;
            select.appendChild(option);
        });
        
        if (videoDevices.length > 0) {
            currentCameraId = videoDevices[0].deviceId;
            select.value = currentCameraId;
        }
        
        select.onchange = function() {
            currentCameraId = this.value;
            if (videoStream) {
                stopScanner();
                setTimeout(startScanner, 500);
            }
        };
        
    } catch (error) {
        console.error('Error loading cameras:', error);
        alert('Tidak dapat mengakses kamera. Pastikan izin kamera diizinkan.');
    }
}

// Mulai scanner
async function startScanner() {
    try {
        // Show loading
        document.getElementById('loadingSpinner').style.display = 'block';
        
        const constraints = {
            video: {
                deviceId: currentCameraId ? { exact: currentCameraId } : undefined,
                facingMode: 'environment', // Prioritize back camera
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        };
        
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const video = document.getElementById('scannerVideo');
        video.srcObject = videoStream;
        
        // Tunggu video siap
        video.onloadedmetadata = () => {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            document.getElementById('captureButton').disabled = false;
            
            // Mulai auto-scan jika mode aktif
            if (document.getElementById('autoModeSwitch').checked) {
                startAutoScan();
            }
        };
        
    } catch (error) {
        console.error('Error starting scanner:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (error.name === 'NotAllowedError') {
            alert('Izin kamera ditolak. Silakan izinkan akses kamera di browser.');
        } else if (error.name === 'NotFoundError') {
            alert('Kamera tidak ditemukan.');
        } else {
            alert('Gagal mengakses kamera: ' + error.message);
        }
    }
}

// Stop scanner
function stopScanner() {
    if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
    
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    
    const video = document.getElementById('scannerVideo');
    video.srcObject = null;
    
    document.getElementById('startButton').disabled = false;
    document.getElementById('stopButton').disabled = true;
    document.getElementById('captureButton').disabled = true;
}

// Ambil frame dari video
function captureFrame() {
    if (!videoStream) return;
    
    const video = document.getElementById('scannerVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Konversi ke blob dan kirim ke server
    canvas.toBlob(blob => {
        processBarcodeImage(blob);
    }, 'image/jpeg', 0.8);
}

// Mulai auto-scan
function startAutoScan() {
    if (scanInterval) clearInterval(scanInterval);
    
    scanInterval = setInterval(() => {
        if (!videoStream) return;
        
        const video = document.getElementById('scannerVideo');
        if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
        
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Kirim untuk processing (dengan rate limit)
        canvas.toBlob(blob => {
            processBarcodeImage(blob);
        }, 'image/jpeg', 0.8);
        
    }, 1000); // Scan setiap 1 detik
}

// Kirim gambar ke server untuk decode barcode
async function processBarcodeImage(imageBlob) {
    try {
        const formData = new FormData();
        formData.append('barcode_image', imageBlob, 'scan.jpg');
        
        const response = await fetch('/api/process_barcode', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.barcode) {
            // Stop auto-scan jika berhasil
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            // Cari produk berdasarkan barcode
            findProductByBarcode(result.barcode);
        }
        
    } catch (error) {
        console.error('Error processing barcode:', error);
    }
}

// Cari produk berdasarkan barcode
async function findProductByBarcode(barcode) {
    try {
        showLoading('Mencari produk...');
        
        const response = await fetch('/api/find_product_by_barcode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ barcode: barcode })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            displayProductResult(result.product);
        } else {
            showResultError('Produk tidak ditemukan untuk barcode: ' + barcode);
        }
        
    } catch (error) {
        console.error('Error finding product:', error);
        hideLoading();
        showResultError('Error: ' + error.message);
    }
}

// Manual scan input
function manualScan() {
    const barcode = document.getElementById('manualBarcode').value.trim();
    if (!barcode) {
        alert('Masukkan kode barcode terlebih dahulu!');
        return;
    }
    
    findProductByBarcode(barcode);
    document.getElementById('manualBarcode').value = '';
}

// Tampilkan hasil produk
function displayProductResult(product) {
    const resultDiv = document.getElementById('scanResult');
    const productDiv = document.getElementById('productInfo');
    
    resultDiv.innerHTML = `
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">Barcode ditemukan!</h6>
                    <p class="mb-0">Kode: <strong>${product.barcode || product.no_SKU}</strong></p>
                </div>
            </div>
        </div>
    `;
    
    productDiv.style.display = 'block';
    productDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">${product.Name_product || product.name}</h6>
                <p class="card-text">
                    <strong>SKU:</strong> ${product.no_SKU || product.sku}<br>
                    <strong>Harga:</strong> Rp${parseInt(product.Price || product.price).toLocaleString()}<br>
                    <strong>Stok:</strong> ${product.stok || 0} pcs<br>
                    <strong>Tipe:</strong> <span class="badge ${product.type === 'lelang' ? 'bg-warning' : 'bg-info'}">${product.type || 'biasa'}</span>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="addToCartFromScanner('${product.no_SKU || product.sku}', '${product.Name_product || product.name}', ${product.Price || product.price}, '${product.type || 'biasa'}')">
                        <i class="bi bi-cart-plus"></i> Tambah ke Keranjang
                    </button>
                    <button class="btn btn-outline-secondary" onclick="scanAnother()">
                        <i class="bi bi-arrow-repeat"></i> Scan Lagi
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Auto-scroll ke hasil
    productDiv.scrollIntoView({ behavior: 'smooth' });
}

// Tambah ke cart dari scanner
function addToCartFromScanner(sku, name, price, type) {
    try {
        console.log('Adding to cart from scanner:', { sku, name, price, type });
        
        // Simpan ke localStorage sebagai fallback
        const cartItem = {
            sku: sku,
            name: name,
            price: parseFloat(price),
            qty: 1,
            subtotal: parseFloat(price),
            mode: type,
            timestamp: new Date().getTime()
        };
        
        // Ambil cart dari localStorage
        let cart = JSON.parse(localStorage.getItem('cartItems') || '[]');
        
        // Cek apakah item sudah ada
        const existingItemIndex = cart.findIndex(item => 
            String(item.sku) === String(sku) && item.mode === type
        );
        
        if (existingItemIndex > -1) {
            // Update quantity jika sudah ada
            cart[existingItemIndex].qty += 1;
            cart[existingItemIndex].subtotal = cart[existingItemIndex].qty * cart[existingItemIndex].price;
        } else {
            // Tambah baru
            cart.push(cartItem);
        }
        
        // Simpan kembali ke localStorage
        localStorage.setItem('cartItems', JSON.stringify(cart));
        
        // Tampilkan notifikasi
        alert(`✅ ${name} berhasil ditambahkan ke keranjang!`);
        
        // Jika di halaman kasir, refresh cart display
        if (window.opener && typeof window.opener.updateCartDisplay === 'function') {
            window.opener.updateCartDisplay();
        }
        
        // Auto-close setelah 2 detik
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (modal) modal.hide();
        }, 2000);
        
    } catch (error) {
        console.error('Error adding to cart from scanner:', error);
        alert('❌ Gagal menambahkan ke keranjang: ' + error.message);
    }
}

// Scan lagi
function scanAnother() {
    document.getElementById('scanResult').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="bi bi-upc-scan fs-1 d-block mb-2"></i>
            Siap untuk scan berikutnya
        </div>
    `;
    
    document.getElementById('productInfo').style.display = 'none';
    
    // Mulai auto-scan lagi
    if (document.getElementById('autoModeSwitch').checked) {
        startAutoScan();
    }
}

// Tampilkan error
function showResultError(message) {
    document.getElementById('scanResult').innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Loading helper
function showLoading(message = 'Memproses...') {
    document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

// Event listener untuk auto-mode switch
document.getElementById('autoModeSwitch').addEventListener('change', function() {
    if (this.checked && videoStream && !scanInterval) {
        startAutoScan();
    } else if (!this.checked && scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
    }
});

// Load kamera saat halaman siap
document.addEventListener('DOMContentLoaded', function() {
    loadCameras();
    
    // Auto-focus ke input manual
    document.getElementById('manualBarcode').focus();
    
    // Cleanup saat halaman ditutup
    window.addEventListener('beforeunload', stopScanner);
});
</script>

<style>
#scannerContainer {
    position: relative;
    height: 400px;
    background: #000;
}

#scannerVideo {
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1); /* Mirror untuk kamera depan */
}

.scanner-overlay {
    position: absolute;
    top: 20%;
    left: 15%;
    right: 15%;
    bottom: 20%;
    border: 2px solid rgba(0, 255, 0, 0.5);
    pointer-events: none;
}

.scanner-guide {
    position: absolute;
    top: 50%;
    left: 15%;
    right: 15%;
    height: 2px;
    background: rgba(0, 255, 0, 0.5);
    animation: scanLine 2s infinite linear;
    pointer-events: none;
}

@keyframes scanLine {
    0% { top: 20%; }
    100% { top: 80%; }
}

@media (max-width: 768px) {
    #scannerContainer {
        height: 300px;
    }
}
</style>
{% endblock %}