{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-upc-scan me-2"></i>Barcode Scanner (Client-side)
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Pilihan Scanner -->
                    <div class="mb-3">
                        <label class="form-label">Pilih Metode Scan:</label>
                        <select id="scannerType" class="form-select mb-3" onchange="changeScannerType()">
                            <option value="html5">HTML5 Scanner (Rekomendasi)</option>
                            <option value="manual">Manual Input</option>
                        </select>
                    </div>
                    
                    <!-- Area Scanner HTML5 -->
                    <div id="html5ScannerArea">
                        <div id="reader" class="border rounded" style="width: 100%; height: 400px;"></div>
                        
                        <div class="mt-3">
                            <button id="startHtml5Btn" class="btn btn-success" onclick="startHtml5Scanner()">
                                <i class="bi bi-play-circle"></i> Mulai Scan
                            </button>
                            <button id="stopHtml5Btn" class="btn btn-danger" onclick="stopHtml5Scanner()" disabled>
                                <i class="bi bi-stop-circle"></i> Stop Scan
                            </button>
                            <button class="btn btn-warning" onclick="switchCamera()">
                                <i class="bi bi-camera-video"></i> Ganti Kamera
                            </button>
                        </div>
                    </div>
                    
                    <!-- Area Manual Input -->
                    <div id="manualInputArea" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Masukkan Kode Barcode:</label>
                            <input type="text" id="manualBarcode" class="form-control" 
                                   placeholder="Contoh: 1, 5, 1001..."
                                   onkeypress="if(event.key === 'Enter') manualScan()">
                        </div>
                        <button class="btn btn-primary w-100" onclick="manualScan()">
                            <i class="bi bi-search"></i> Cari Produk
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Hasil Scan -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-check-circle me-2"></i>Hasil Scan
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scanResult">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-upc-scan fs-1 d-block mb-2"></i>
                            Silakan scan barcode atau ketik manual
                        </div>
                    </div>
                    
                    <div class="mt-3" id="productInfo" style="display: none;"></div>
                </div>
            </div>
            
            <!-- Recent Scans -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Scan Terakhir
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recentScans" class="small">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Load HTML5 QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
// ============================================
// CLIENT-SIDE BARCODE SCANNER (NO SERVER DEPENDENCY)
// ============================================

let html5QrCode = null;
let currentCameraId = null;

// Ganti tipe scanner
function changeScannerType() {
    const type = document.getElementById('scannerType').value;
    
    if (type === 'html5') {
        document.getElementById('html5ScannerArea').style.display = 'block';
        document.getElementById('manualInputArea').style.display = 'none';
        stopHtml5Scanner(); // Stop dulu
    } else {
        document.getElementById('html5ScannerArea').style.display = 'none';
        document.getElementById('manualInputArea').style.display = 'block';
        stopHtml5Scanner(); // Stop scanner
    }
}

// Mulai HTML5 Scanner
async function startHtml5Scanner() {
    try {
        // Dapatkan list kamera
        const cameras = await Html5Qrcode.getCameras();
        
        if (cameras.length === 0) {
            alert('Tidak ada kamera ditemukan!');
            return;
        }
        
        // Pilih kamera belakang jika ada
        let selectedCamera = cameras[0];
        const backCamera = cameras.find(cam => 
            cam.label.toLowerCase().includes('back') || 
            cam.label.toLowerCase().includes('rear')
        );
        
        if (backCamera) {
            selectedCamera = backCamera;
        }
        
        currentCameraId = selectedCamera.id;
        
        // Stop scanner sebelumnya jika ada
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }
        
        // Buat instance baru
        html5QrCode = new Html5Qrcode("reader");
        
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
        };
        
        // Mulai scanning
        await html5QrCode.start(
            currentCameraId,
            config,
            onScanSuccess,
            onScanError
        );
        
        // Update button state
        document.getElementById('startHtml5Btn').disabled = true;
        document.getElementById('stopHtml5Btn').disabled = false;
        
        console.log('‚úÖ HTML5 Scanner started');
        
    } catch (error) {
        console.error('Error starting scanner:', error);
        alert('Gagal memulai scanner: ' + error.message);
        
        // Fallback ke manual input
        document.getElementById('scannerType').value = 'manual';
        changeScannerType();
    }
}

// Stop HTML5 Scanner
async function stopHtml5Scanner() {
    try {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }
        
        document.getElementById('startHtml5Btn').disabled = false;
        document.getElementById('stopHtml5Btn').disabled = true;
        
        console.log('üõë Scanner stopped');
        
    } catch (error) {
        console.error('Error stopping scanner:', error);
    }
}

// Ganti kamera
async function switchCamera() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        
        if (cameras.length < 2) {
            alert('Hanya ada 1 kamera tersedia');
            return;
        }
        
        // Cari kamera lain
        const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
        const nextIndex = (currentIndex + 1) % cameras.length;
        currentCameraId = cameras[nextIndex].id;
        
        // Restart dengan kamera baru
        await stopHtml5Scanner();
        setTimeout(startHtml5Scanner, 500);
        
    } catch (error) {
        console.error('Error switching camera:', error);
    }
}

// Callback saat scan berhasil
function onScanSuccess(decodedText, decodedResult) {
    console.log(`Scan result: ${decodedText}`);
    
    // Stop scanner sementara
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.pause();
    }
    
    // Cari produk
    findProductByBarcode(decodedText);
    
    // Resume scanning setelah 2 detik
    setTimeout(() => {
        if (html5QrCode) {
            html5QrCode.resume();
        }
    }, 2000);
}

// Callback saat scan error (biasanya karena tidak ada barcode)
function onScanError(error) {
    // Biarkan saja, scanner akan terus mencoba
}

// Manual scan input
function manualScan() {
    const barcode = document.getElementById('manualBarcode').value.trim();
    if (!barcode) {
        alert('Masukkan kode barcode terlebih dahulu!');
        return;
    }
    
    findProductByBarcode(barcode);
    document.getElementById('manualBarcode').value = '';
}

// Cari produk berdasarkan barcode
async function findProductByBarcode(barcode) {
    try {
        showLoading('Mencari produk...');
        
        // Gunakan endpoint yang sudah ada
        const response = await fetch('/api/find_product_by_barcode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ barcode: barcode })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            displayProductResult(result.product);
            saveRecentScan(barcode, result.product.Name_product);
        } else {
            // Coba endpoint alternatif
            await tryAlternativeSearch(barcode);
        }
        
    } catch (error) {
        console.error('Error finding product:', error);
        hideLoading();
        showResultError('Error: ' + error.message);
    }
}

// Coba endpoint alternatif
async function tryAlternativeSearch(barcode) {
    try {
        // Coba search biasa
        const response = await fetch(`/api/search?q=${encodeURIComponent(barcode)}`);
        const data = await response.json();
        
        if (Array.isArray(data) && data.length > 0) {
            displayProductResult(data[0]);
            saveRecentScan(barcode, data[0].Name_product);
        } else {
            showResultError('Produk tidak ditemukan: ' + barcode);
        }
    } catch (error) {
        showResultError('Produk SKU ' + barcode + ' tidak ditemukan');
    }
}

// Tampilkan hasil produk
function displayProductResult(product) {
    const resultDiv = document.getElementById('scanResult');
    const productDiv = document.getElementById('productInfo');
    
    // Escape quotes untuk JavaScript
    const safeName = (product.Name_product || product.name || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    resultDiv.innerHTML = `
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">Barcode ditemukan!</h6>
                    <p class="mb-0">SKU: <strong>${product.no_SKU || product.sku}</strong></p>
                </div>
            </div>
        </div>
    `;
    
    productDiv.style.display = 'block';
    productDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">${product.Name_product || product.name}</h6>
                <p class="card-text">
                    <strong>SKU:</strong> ${product.no_SKU || product.sku}<br>
                    <strong>Harga:</strong> Rp${parseInt(product.Price || product.price).toLocaleString()}<br>
                    <strong>Stok:</strong> ${product.stok || 0} pcs<br>
                    <strong>Tipe:</strong> <span class="badge ${product.type === 'lelang' ? 'bg-warning' : 'bg-info'}">${product.type || 'biasa'}</span>
                </p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="addToCartFromScanner('${product.no_SKU || product.sku}', '${safeName}', ${product.Price || product.price}, '${product.type || 'biasa'}')">
                        <i class="bi bi-cart-plus"></i> Tambah ke Keranjang
                    </button>
                    <button class="btn btn-outline-secondary" onclick="scanAnother()">
                        <i class="bi bi-arrow-repeat"></i> Scan Lagi
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Auto-scroll ke hasil
    productDiv.scrollIntoView({ behavior: 'smooth' });
}

// Tambah ke cart dari scanner (SIMPLE VERSION)
function addToCartFromScanner(sku, name, price, type) {
    try {
        // Ambil cart dari localStorage
        let cart = JSON.parse(localStorage.getItem('cartItems') || '[]');
        
        // Cek apakah item sudah ada
        const existingItem = cart.find(item => 
            String(item.sku) === String(sku) && item.mode === type
        );
        
        if (existingItem) {
            existingItem.qty += 1;
            existingItem.subtotal = existingItem.qty * existingItem.price;
        } else {
            cart.push({
                sku: sku,
                name: name,
                price: parseFloat(price),
                qty: 1,
                subtotal: parseFloat(price),
                mode: type
            });
        }
        
        // Simpan kembali
        localStorage.setItem('cartItems', JSON.stringify(cart));
        
        // Tampilkan notifikasi
        alert(`‚úÖ ${name} berhasil ditambahkan ke keranjang!`);
        
        // Tawarkan buka kasir
        if (confirm('Buka halaman kasir sekarang?')) {
            window.location.href = '/kasir';
        }
        
    } catch (error) {
        console.error('Error adding to cart:', error);
        alert('‚ùå Gagal menambahkan ke keranjang');
    }
}

// Scan lagi
function scanAnother() {
    document.getElementById('scanResult').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="bi bi-upc-scan fs-1 d-block mb-2"></i>
            Siap untuk scan berikutnya
        </div>
    `;
    
    document.getElementById('productInfo').style.display = 'none';
}

// Tampilkan error
function showResultError(message) {
    document.getElementById('scanResult').innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Simpan scan terakhir
function saveRecentScan(barcode, productName) {
    try {
        let recentScans = JSON.parse(localStorage.getItem('recentScans') || '[]');
        
        // Tambah ke awal
        recentScans.unshift({
            barcode: barcode,
            productName: productName,
            timestamp: new Date().toISOString()
        });
        
        // Maksimal 5 item
        recentScans = recentScans.slice(0, 5);
        
        localStorage.setItem('recentScans', JSON.stringify(recentScans));
        
        // Update tampilan
        updateRecentScans();
        
    } catch (error) {
        console.error('Error saving recent scan:', error);
    }
}

// Update daftar scan terakhir
function updateRecentScans() {
    try {
        const recentScans = JSON.parse(localStorage.getItem('recentScans') || '[]');
        const container = document.getElementById('recentScans');
        
        if (recentScans.length === 0) {
            container.innerHTML = '<div class="text-muted">Belum ada scan</div>';
            return;
        }
        
        let html = '';
        recentScans.forEach((scan, index) => {
            const timeAgo = getTimeAgo(new Date(scan.timestamp));
            html += `
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <small class="d-block">${scan.productName || 'Unknown'}</small>
                        <small class="text-muted">${scan.barcode}</small>
                    </div>
                    <small class="text-muted">${timeAgo}</small>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error updating recent scans:', error);
    }
}

// Helper: format waktu
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'baru saja';
    if (diffMins < 60) return `${diffMins}m`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}j`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}h`;
}

// Loading helper
function showLoading(message = 'Memproses...') {
    document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Set default ke HTML5 scanner
    document.getElementById('scannerType').value = 'html5';
    changeScannerType();
    
    // Load recent scans
    updateRecentScans();
    
    // Cleanup saat halaman ditutup
    window.addEventListener('beforeunload', function() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop();
        }
    });
});
</script>

<style>
#reader {
    background: #000;
    border-radius: 8px;
}

/* Scanner overlay styling */
#reader video {
    border-radius: 8px;
}

@media (max-width: 768px) {
    #reader {
        height: 300px;
    }
}
</style>
{% endblock %}