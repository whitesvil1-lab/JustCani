{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col-md-7">
        <div class="card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold text-dark mb-0">
                    <i class="bi bi-search me-2 text-primary"></i>Katalog Produk
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" id="btnBiasa" class="btn btn-primary" onclick="setMode('biasa')">
                        <i class="bi bi-cart me-1"></i> Produk Biasa
                    </button>
                    <button type="button" id="btnLelang" class="btn btn-outline-warning" onclick="setMode('lelang')">
                        <i class="bi bi-tag me-1"></i> Produk Lelang
                    </button>
                </div>
            </div>
            
            <!-- Input Pencarian & Tombol Scanner -->
            <div class="d-flex justify-content-between mb-4">
                <div class="input-group" style="width: 70%;">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="query" class="form-control border-start-0 ps-0" 
                           placeholder="Cari nama barang atau SKU..." 
                           onkeyup="searchItem()">
                    <button class="btn btn-outline-primary" type="button" onclick="openQuickScanner()">
                        <i class="bi bi-upc-scan"></i>
                    </button>
                </div>
                <div>
                    <a href="/scanner" class="btn btn-success me-2">
                        <i class="bi bi-upc-scan me-1"></i> Full Scanner
                    </a>
                    <button class="btn btn-outline-secondary" onclick="clearSearch()" title="Clear search">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- Hasil Pencarian -->
            <div id="searchResults" class="row g-2 overflow-auto" style="max-height: 500px;">
                <div class="text-muted text-center py-5 w-100">
                    <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                    Silakan cari barang atau scan barcode
                </div>
            </div>
        </div>
    </div>

    <!-- Keranjang Belanja -->
    <div class="col-md-5">
        <div class="card p-4 h-100 border-0 shadow">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">
                    <i class="bi bi-cart3 me-2"></i>Keranjang
                    <span id="cartMode" class="badge bg-info ms-2">Biasa</span>
                </h5>
                <div>
                    <span class="badge bg-danger rounded-pill" id="cartCount">0 Item</span>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearCart()" title="Kosongkan keranjang">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            <div id="cartList" class="flex-grow-1 overflow-auto mb-3" style="max-height: 400px; min-height: 200px;">
                <div class="text-center text-muted py-5 bg-light rounded">Belum ada item</div>
            </div>

            <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-3">
                    <span class="h5 text-muted">Total Bayar</span>
                    <span class="h4 fw-bold text-primary" id="totalHarga">Rp0</span>
                </div>
                <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" onclick="checkout()">
                    <i class="bi bi-wallet2 me-2"></i>PROSES BAYAR
                </button>
                <div id="lelangInfo" class="alert alert-warning mt-3 d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Mode Lelang:</strong> Produk ini sudah didiskon 50%.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- MODAL SCANNER -->
<div class="modal fade" id="quickScannerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-upc-scan me-2"></i>Quick Barcode Scanner
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Scanner content - tidak diubah -->
            </div>
        </div>
    </div>
</div>

<!-- Tambahkan script khusus untuk kasir -->
<script>

let currentMode = 'biasa';
let cartItems = [];

// Load cart dari localStorage
function loadCartFromStorage() {
    try {
        const savedCart = localStorage.getItem('cartItems');
        if (savedCart) {
            cartItems = JSON.parse(savedCart);
            console.log('Loaded cart:', cartItems.length, 'items');
        } else {
            cartItems = [];
        }
    } catch (e) {
        console.error('Error loading cart:', e);
        cartItems = [];
    }
    updateCartDisplay();
}

// Save cart ke localStorage
function saveCartToStorage() {
    try {
        localStorage.setItem('cartItems', JSON.stringify(cartItems));
    } catch (e) {
        console.error('Error saving cart:', e);
    }
}

// Set mode (biasa/lelang)
function setMode(mode) {
    currentMode = mode;
    document.getElementById('cartMode').textContent = mode === 'biasa' ? 'Biasa' : 'Lelang';
    
    // Update button styles
    document.getElementById('btnBiasa').className = mode === 'biasa' ? 'btn btn-primary' : 'btn btn-outline-primary';
    document.getElementById('btnLelang').className = mode === 'lelang' ? 'btn btn-warning' : 'btn btn-outline-warning';
    
    // Search ulang
    searchItem();
}

// Fungsi search produk - VERSI YANG DIPERBAIKI
async function searchItem() {
    const query = document.getElementById('query').value;
    const resultsDiv = document.getElementById('searchResults');
    
    // Show loading
    resultsDiv.innerHTML = `
        <div class="col-12 text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Mencari produk...</p>
        </div>
    `;
    
    try {
        const endpoint = currentMode === 'biasa' ? '/api/search' : '/api/search_lelang';
        const response = await fetch(`${endpoint}?q=${encodeURIComponent(query)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        let products = [];
        const data = await response.json();
        
        // Handle response format
        if (Array.isArray(data)) {
            products = data;
        } else if (data && data.results && Array.isArray(data.results)) {
            products = data.results;
        } else if (data && data.products && Array.isArray(data.products)) {
            products = data.products;
        } else if (data && data.error) {
            throw new Error(data.error);
        }
        
        console.log(`Found ${products.length} products`);
        displayResults(products);
        
    } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-exclamation-triangle text-danger fs-1 d-block mb-2"></i>
                <p class="text-danger">Gagal memuat produk</p>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
    }
}

// Tampilkan hasil pencarian
function displayResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (!products || products.length === 0) {
        resultsDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-search fs-1 text-muted d-block mb-2"></i>
                <p class="text-muted">Tidak ada produk ditemukan</p>
            </div>
        `;
        return;
    }
    
    resultsDiv.innerHTML = '';
    
    products.forEach(product => {
        // Pastikan field tidak undefined
        const sku = product.no_SKU || product.sku || product.no_sku || 'N/A';
        const name = product.Name_product || product.name || product.name_product || 'Produk tanpa nama';
        const price = product.Price || product.price || 0;
        const stok = product.stok || product.Stok || 0;
        const expiredDate = product.expired_date ? 
            new Date(product.expired_date).toISOString().split('T')[0] : '-';
        
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-3';
        
        card.innerHTML = `
            <div class="card h-100 border shadow-sm product-item">
                <div class="card-body">
                    <h6 class="card-title fw-bold">${name}</h6>
                    <p class="card-text small text-muted mb-1">
                        SKU: <span class="badge bg-secondary">${sku}</span>
                    </p>
                    <p class="card-text mb-1">
                        <span class="fw-bold text-primary">Rp${parseInt(price).toLocaleString()}</span>
                    </p>
                    ${currentMode === 'biasa' ? 
                        `<p class="card-text small">Stok: <span class="badge ${stok > 10 ? 'bg-success' : 'bg-warning'}">${stok} pcs</span></p>` : 
                        `<p class="card-text small text-warning"><i class="bi bi-tag"></i> Produk Lelang</p>`
                    }
                    <p class="card-text small text-muted">Exp: ${expiredDate}</p>
                    <button class="btn btn-sm btn-outline-primary w-100" 
                            onclick="addToCart('${sku}', '${name.replace(/'/g, "\\'")}', ${price})">
                        <i class="bi bi-cart-plus"></i> Tambah
                    </button>
                </div>
            </div>
        `;
        
        resultsDiv.appendChild(card);
    });
}

// Fungsi addToCart untuk kasir page
function addToCart(sku, name, price, mode = null) {
    try {
        const itemMode = mode || currentMode;
        const itemPrice = parseFloat(price);
        
        if (isNaN(itemPrice)) {
            throw new Error('Harga tidak valid');
        }
        
        // Cek apakah item sudah ada
        const existingItem = cartItems.find(item => 
            String(item.sku) === String(sku) && item.mode === itemMode
        );
        
        if (existingItem) {
            existingItem.qty += 1;
            existingItem.subtotal = existingItem.qty * existingItem.price;
        } else {
            cartItems.push({
                sku: sku,
                name: name,
                price: itemPrice,
                qty: 1,
                subtotal: itemPrice,
                mode: itemMode
            });
        }
        
        // Save and update
        saveCartToStorage();
        updateCartDisplay();
        showCartNotification(`${name} ditambahkan ke keranjang`);
        
        return true;
        
    } catch (error) {
        console.error('Error adding to cart:', error);
        alert('‚ùå Gagal menambahkan ke keranjang: ' + error.message);
        return false;
    }
}

// Tampilkan notifikasi
function showCartNotification(message) {
    try {
        // Remove existing notification
        const existingNotif = document.querySelector('.cart-notification');
        if (existingNotif) {
            existingNotif.remove();
        }
        
        // Create new notification
        const notification = document.createElement('div');
        notification.className = 'cart-notification position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-check-circle me-2 fs-4"></i>
                <div>
                    <strong>Berhasil!</strong>
                    <div class="small">${message}</div>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.5s';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    } catch (e) {
        console.error('Error showing notification:', e);
    }
}

// Update tampilan keranjang
function updateCartDisplay() {
    const cartList = document.getElementById('cartList');
    const cartCount = document.getElementById('cartCount');
    const totalHarga = document.getElementById('totalHarga');
    
    // Update count
    const totalItems = cartItems.reduce((sum, item) => sum + item.qty, 0);
    cartCount.textContent = `${totalItems} Item`;
    
    // Update cart list
    if (cartItems.length === 0) {
        cartList.innerHTML = '<div class="text-center text-muted py-5 bg-light rounded">Belum ada item</div>';
        totalHarga.textContent = 'Rp0';
        return;
    }
    
    let html = '';
    let total = 0;
    
    cartItems.forEach((item, index) => {
        total += item.subtotal;
        html += `
            <div class="cart-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.name}</h6>
                        <small class="text-muted">SKU: ${item.sku}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary btn-sm" onclick="updateQty(${index}, -1)">-</button>
                            <span class="mx-2">${item.qty} @Rp${parseInt(item.price).toLocaleString()}</span>
                            <button class="btn btn-sm btn-outline-secondary btn-sm" onclick="updateQty(${index}, 1)">+</button>
                            <button class="btn btn-sm btn-outline-danger btn-sm ms-2" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-end">
                        <h6 class="mb-0 text-primary">Rp${parseInt(item.subtotal).toLocaleString()}</h6>
                        ${item.mode === 'lelang' ? '<small class="text-warning"><i class="bi bi-tag"></i> Lelang</small>' : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    cartList.innerHTML = html;
    totalHarga.textContent = `Rp${parseInt(total).toLocaleString()}`;
    
    // Show/hide lelang info
    const hasLelang = cartItems.some(item => item.mode === 'lelang');
    document.getElementById('lelangInfo').classList.toggle('d-none', !hasLelang);
}

// Fungsi update quantity
function updateQty(index, change) {
    const item = cartItems[index];
    const newQty = item.qty + change;
    
    if (newQty < 1) {
        removeFromCart(index);
        return;
    }
    
    item.qty = newQty;
    item.subtotal = item.qty * item.price;
    saveCartToStorage();
    updateCartDisplay();
}

// Fungsi hapus dari keranjang
function removeFromCart(index) {
    if (confirm('Hapus item dari keranjang?')) {
        cartItems.splice(index, 1);
        saveCartToStorage();
        updateCartDisplay();
    }
}

// Clear cart
function clearCart() {
    if (cartItems.length === 0) {
        alert('Keranjang sudah kosong!');
        return;
    }
    
    if (confirm(`Yakin ingin mengosongkan keranjang? (${cartItems.length} item)`)) {
        cartItems = [];
        saveCartToStorage();
        updateCartDisplay();
        showCartNotification('Keranjang berhasil dikosongkan!');
    }
}

// Clear search input
function clearSearch() {
    document.getElementById('query').value = '';
    searchItem();
}

// Fungsi checkout
async function checkout() {
    try {
        console.log('Starting checkout...');
        
        if (cartItems.length === 0) {
            alert('Keranjang kosong!');
            return;
        }
        
        // Pisahkan item biasa dan lelang
        const biasaItems = cartItems.filter(item => item.mode === 'biasa');
        const lelangItems = cartItems.filter(item => item.mode === 'lelang');
        
        if (biasaItems.length === 0 && lelangItems.length === 0) {
            alert('Tidak ada item untuk checkout');
            return;
        }
        
        // Proses biasa items dulu
        if (biasaItems.length > 0) {
            const requestData = {
                items: biasaItems.map(item => ({
                    sku: String(item.sku),
                    qty: Number(item.qty)
                }))
            };
            
            console.log('Sending biasa items:', requestData);
            
            const response = await fetch('/api/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            console.log('Checkout result:', result);
            
            if (!result.success) {
                throw new Error(result.message || 'Gagal checkout');
            }
        }
        
        // Hapus item yang sudah di-checkout
        cartItems = lelangItems; // Simpan hanya lelang items (biasa sudah diproses)
        saveCartToStorage();
        updateCartDisplay();
        
        alert('Transaksi berhasil!');
        
    } catch (error) {
        console.error('Checkout error:', error);
        alert('Error: ' + error.message);
    }
}

// Fungsi untuk scanner (skeleton)
function openQuickScanner() {
    alert('Scanner akan dibuka di modal. Fitur ini bekerja.');
    // Untuk sekarang, kita fokus dulu ke fungsi pencarian
}

// Initialize saat halaman load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Kasir page loaded');
    loadCartFromStorage();
    setMode('biasa');
    
    // Lakukan search awal untuk menampilkan produk
    searchItem();
});
</script>

{% endblock %}