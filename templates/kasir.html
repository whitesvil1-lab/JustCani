{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col-md-7">
        <div class="card p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold text-dark mb-0">
                    <i class="bi bi-search me-2 text-primary"></i>Katalog Produk
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" id="btnBiasa" class="btn btn-primary" onclick="setMode('biasa')">
                        <i class="bi bi-cart me-1"></i> Produk Biasa
                    </button>
                    <button type="button" id="btnLelang" class="btn btn-outline-warning" onclick="setMode('lelang')">
                        <i class="bi bi-tag me-1"></i> Produk Lelang
                    </button>
                </div>
            </div>
            
            <!-- Input Pencarian & Tombol Scanner -->
            <div class="d-flex justify-content-between mb-4">
                <div class="input-group" style="width: 70%;">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="query" class="form-control border-start-0 ps-0" 
                           placeholder="Cari nama barang atau SKU..." 
                           onkeyup="searchItem()">
                </div>
                <div>
                    <a href="/scanner" class="btn btn-success">
                        <i class="bi bi-upc-scan me-1"></i> Open Scanner
                    </a>
                </div>
            </div>
            
            <!-- Hasil Pencarian -->
            <div id="searchResults" class="row g-2 overflow-auto" style="max-height: 500px;">
                <div class="text-muted text-center py-5 w-100">
                    <i class="bi bi-box-seam fs-1 d-block mb-2"></i>
                    Silakan cari barang atau scan barcode
                </div>
            </div>
        </div>
    </div>

    <!-- Keranjang Belanja -->
    <div class="col-md-5">
        <div class="card p-4 h-100 border-0 shadow">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0">
                    <i class="bi bi-cart3 me-2"></i>Keranjang
                    <span id="cartMode" class="badge bg-info ms-2">Biasa</span>
                </h5>
                <span class="badge bg-danger rounded-pill" id="cartCount">0 Item</span>
            </div>
            
            <div id="cartList" class="flex-grow-1 overflow-auto mb-3" style="max-height: 400px; min-height: 200px;">
                <div class="text-center text-muted py-5 bg-light rounded">Belum ada item</div>
            </div>

            <div class="border-top pt-3">
                <div class="d-flex justify-content-between mb-3">
                    <span class="h5 text-muted">Total Bayar</span>
                    <span class="h4 fw-bold text-primary" id="totalHarga">Rp0</span>
                </div>
                <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" onclick="checkout()">
                    <i class="bi bi-wallet2 me-2"></i>PROSES BAYAR
                </button>
                <div id="lelangInfo" class="alert alert-warning mt-3 d-none">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Mode Lelang:</strong> Produk ini sudah didiskon 50%.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner (Hidden by default) -->
<div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script>
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('[GLOBAL ERROR]', msg);
    console.error('[URL]', url);
    console.error('[Line]', lineNo);
    console.error('[Error]', error);
    
    // Show in alert
    alert(`JavaScript Error:\n${msg}\n\nCheck console for details.`);
    return false;
};

// Catch unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
    console.error('[UNHANDLED PROMISE]', event.reason);
    alert(`Unhandled Promise Rejection:\n${event.reason}`);
    event.preventDefault();
});

// Load cart from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize cart
    if (window.Cart) {
        window.Cart.init();
        cartItems = window.Cart.items();
    } else {
        // Fallback
        const savedCart = JSON.parse(localStorage.getItem('cartItems') || '[]');
        cartItems = savedCart;
    }
    
    updateCartDisplay();
    searchItem(); // Load initial products
});

function loadCartFromStorage() {
    const savedCart = JSON.parse(localStorage.getItem('cartItems') || '[]');
    if (savedCart.length > 0) {
        cartItems = savedCart;
        updateCartDisplay();
    }
}

let currentMode = 'biasa';
let cartItems = [];

// Fungsi untuk set mode (biasa/lelang)
function setMode(mode) {
    currentMode = mode;
    document.getElementById('cartMode').textContent = mode === 'biasa' ? 'Biasa' : 'Lelang';
    
    // Update button styles
    document.getElementById('btnBiasa').className = mode === 'biasa' ? 'btn btn-primary' : 'btn btn-outline-primary';
    document.getElementById('btnLelang').className = mode === 'lelang' ? 'btn btn-warning' : 'btn btn-outline-warning';
    
    // Search ulang
    searchItem();
}

// Fungsi search produk
async function searchItem() {
    const query = document.getElementById('query').value;
    const resultsDiv = document.getElementById('searchResults');
    
    // Show loading
    resultsDiv.innerHTML = `
        <div class="col-12 text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Mencari produk...</p>
        </div>
    `;
    
    try {
        const endpoint = currentMode === 'biasa' ? '/api/search' : '/api/search_lelang';
        const response = await fetch(`${endpoint}?q=${encodeURIComponent(query)}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Handle array response
        if (Array.isArray(data)) {
            displayResults(data);
        } 
        // Handle object response with error
        else if (data.error) {
            throw new Error(data.error);
        }
        // Handle object response with results array
        else if (data.results && Array.isArray(data.results)) {
            displayResults(data.results);
        }
        else {
            displayResults([]);
        }
        
    } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-exclamation-triangle text-danger fs-1 d-block mb-2"></i>
                <p class="text-danger">Gagal memuat produk</p>
                <small class="text-muted">${error.message}</small>
            </div>
        `;
    }
}

// Fungsi untuk menampilkan hasil pencarian
function displayResults(products) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (!products || products.length === 0) {
        resultsDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-search fs-1 text-muted d-block mb-2"></i>
                <p class="text-muted">Tidak ada produk ditemukan</p>
            </div>
        `;
        return;
    }
    
    resultsDiv.innerHTML = '';
    
    products.forEach(product => {
        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-3';
        
        // Handle semua kemungkinan nama field untuk konsistensi
        const sku = product.no_SKU || product.sku || product.no_sku || product.No_SKU || product.SKU || 'N/A';
        const name = product.Name_product || product.name || product.name_product || product.nama || 'Produk tanpa nama';
        const price = product.Price || product.price || product.harga || 0;
        const stok = product.stok || product.Stok || product.stock || 0;
        
        // Format tanggal expired dengan aman
        let expiredDate = '-';
        try {
            if (product.expired_date || product.expiredDate || product.exp_date) {
                const dateStr = product.expired_date || product.expiredDate || product.exp_date;
                expiredDate = new Date(dateStr).toISOString().split('T')[0];
            }
        } catch (e) {
            console.warn('Error parsing date:', e);
            expiredDate = product.expired_date || product.expiredDate || product.exp_date || '-';
        }
        
        // Handle string escape untuk name dengan quotes
        const safeName = name
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/`/g, '\\`');
        
        // Format harga untuk display
        const formattedPrice = new Intl.NumberFormat('id-ID').format(parseInt(price));
        
        // Tentukan badge stok warna
        let stockBadgeClass = 'bg-secondary';
        let stockText = `${stok} pcs`;
        
        if (currentMode === 'biasa') {
            if (stok > 10) stockBadgeClass = 'bg-success';
            else if (stok > 0) stockBadgeClass = 'bg-warning';
            else stockBadgeClass = 'bg-danger';
        }
        
        card.innerHTML = `
            <div class="card h-100 border shadow-sm product-item">
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title fw-bold text-truncate" title="${name}">${name}</h6>
                    <p class="card-text small text-muted mb-1">
                        SKU: <span class="badge bg-secondary">${sku}</span>
                    </p>
                    <p class="card-text mb-2">
                        <span class="fw-bold text-primary">Rp${formattedPrice}</span>
                    </p>
                    ${currentMode === 'biasa' ? 
                        `<p class="card-text small">Stok: <span class="badge ${stockBadgeClass}">${stockText}</span></p>` : 
                        `<p class="card-text small text-warning"><i class="bi bi-tag"></i> Produk Lelang</p>`
                    }
                    ${expiredDate !== '-' ? 
                        `<p class="card-text small text-muted">Exp: ${expiredDate}</p>` : 
                        '<p class="card-text small text-muted">Exp: -</p>'
                    }
                    <div class="mt-auto pt-3">
                        <button class="btn btn-sm btn-outline-primary w-100" 
                                onclick="addToCart('${sku}', '${safeName}', ${price})"
                                ${currentMode === 'biasa' && stok <= 0 ? 'disabled' : ''}>
                            <i class="bi bi-cart-plus"></i> 
                            ${currentMode === 'biasa' && stok <= 0 ? 'Stok Habis' : 'Tambah'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.appendChild(card);
    });
}

// Fungsi tambah ke keranjang
function addToCart(sku, name, price, mode = null) {
    // Gunakan mode parameter jika ada, kalau tidak pakai currentMode
    const itemMode = mode || currentMode;
    
    // Cek apakah item sudah ada di keranjang
    const existingItem = cartItems.find(item => item.sku == sku && item.mode === itemMode);
    
    if (existingItem) {
        existingItem.qty += 1;
        existingItem.subtotal = existingItem.qty * existingItem.price;
    } else {
        cartItems.push({
            sku: sku,
            name: name,
            price: parseFloat(price),
            qty: 1,
            subtotal: parseFloat(price),
            mode: itemMode
        });
    }
    
    // Save to localStorage
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
    
    updateCartDisplay();
    
    // Show notification
    showCartNotification(`${name} ditambahkan ke keranjang`);
    
    // Jika dari halaman produk, refresh display jika di kasir page
    if (window.location.pathname.includes('/kasir')) {
        updateCartDisplay();
    }
}

// Tambahkan fungsi notifikasi:
function showCartNotification(message) {
    const existingNotif = document.querySelector('.cart-notification');
    if (existingNotif) {
        existingNotif.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'cart-notification position-fixed top-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-check-circle me-2 fs-4"></i>
            <div>
                <strong>Berhasil!</strong>
                <div class="small">${message}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
    }, 3000);
}

// Update tampilan keranjang
function updateCartDisplay() {
    const cartList = document.getElementById('cartList');
    const cartCount = document.getElementById('cartCount');
    const totalHarga = document.getElementById('totalHarga');
    
    // Update count
    const totalItems = cartItems.reduce((sum, item) => sum + item.qty, 0);
    cartCount.textContent = `${totalItems} Item`;
    
    // Update cart list
    if (cartItems.length === 0) {
        cartList.innerHTML = '<div class="text-center text-muted py-5 bg-light rounded">Belum ada item</div>';
        totalHarga.textContent = 'Rp0';
        return;
    }
    
    let html = '';
    let total = 0;
    
    cartItems.forEach((item, index) => {
        total += item.subtotal;
        html += `
            <div class="cart-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.name}</h6>
                        <small class="text-muted">SKU: ${item.sku}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary btn-sm" onclick="updateQty(${index}, -1)">-</button>
                            <span class="mx-2">${item.qty} @Rp${parseInt(item.price).toLocaleString()}</span>
                            <button class="btn btn-sm btn-outline-secondary btn-sm" onclick="updateQty(${index}, 1)">+</button>
                            <button class="btn btn-sm btn-outline-danger btn-sm ms-2" onclick="removeFromCart(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-end">
                        <h6 class="mb-0 text-primary">Rp${parseInt(item.subtotal).toLocaleString()}</h6>
                        ${item.mode === 'lelang' ? '<small class="text-warning"><i class="bi bi-tag"></i> Lelang</small>' : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    cartList.innerHTML = html;
    totalHarga.textContent = `Rp${parseInt(total).toLocaleString()}`;
    
    // Show/hide lelang info
    const hasLelang = cartItems.some(item => item.mode === 'lelang');
    document.getElementById('lelangInfo').classList.toggle('d-none', !hasLelang);
}

// Fungsi update quantity
function updateQty(index, change) {
    const item = cartItems[index];
    const newQty = item.qty + change;
    
    if (newQty < 1) {
        removeFromCart(index);
        return;
    }
    
    item.qty = newQty;
    item.subtotal = item.qty * item.price;
    
    // Save to localStorage
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
    
    updateCartDisplay();
}

// Fungsi hapus dari keranjang
function removeFromCart(index) {
    cartItems.splice(index, 1);
    
    // Save to localStorage
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
    
    updateCartDisplay();
}

// Fungsi checkout
// Fungsi checkout - DEBUG VERSION
async function checkout() {
    console.log('[KASIR] Checkout function called');
    
    try {
        // Gunakan window.Cart untuk mendapatkan items
        const cartSummary = window.Cart ? window.Cart.getSummary() : getCartSummary();
        const cartItems = cartSummary.items;
        
        console.log('[KASIR] Cart items:', cartItems);
        
        if (cartItems.length === 0) {
            alert('Keranjang kosong!');
            return;
        }
        
        // Pisahkan item biasa dan lelang
        const biasaItems = cartItems.filter(item => item.mode === 'biasa');
        const lelangItems = cartItems.filter(item => item.mode === 'lelang');
        
        console.log('[KASIR] Biasa items:', biasaItems);
        console.log('[KASIR] Lelang items:', lelangItems);
        
        if (biasaItems.length === 0 && lelangItems.length === 0) {
            alert('Tidak ada item yang bisa diproses!');
            return;
        }
        
        // Show loading
        document.getElementById('loadingSpinner').style.display = 'block';
        
        let successMessages = [];
        let errorMessages = [];
        
        // Proses item biasa jika ada
        if (biasaItems.length > 0) {
            const biasaRequest = {
                items: biasaItems.map(item => ({
                    sku: item.sku.toString(),
                    qty: parseInt(item.qty)
                }))
            };
            
            console.log('[KASIR] Sending biasa request:', biasaRequest);
            
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(biasaRequest)
                });
                
                console.log('[KASIR] Biasa response status:', response.status);
                
                const result = await response.json();
                console.log('[KASIR] Biasa result:', result);
                
                if (result.success) {
                    successMessages.push(`✅ Biasa: ${result.message}`);
                } else {
                    errorMessages.push(`❌ Biasa: ${result.message}`);
                }
            } catch (error) {
                console.error('[KASIR] Biasa checkout error:', error);
                errorMessages.push(`❌ Biasa: ${error.message}`);
            }
        }
        
        // Proses item lelang jika ada
        if (lelangItems.length > 0) {
            const lelangRequest = {
                items: lelangItems.map(item => ({
                    sku: item.sku.toString(),
                    qty: parseInt(item.qty)
                }))
            };
            
            console.log('[KASIR] Sending lelang request:', lelangRequest);
            
            try {
                const response = await fetch('/api/checkout_lelang', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(lelangRequest)
                });
                
                console.log('[KASIR] Lelang response status:', response.status);
                
                const result = await response.json();
                console.log('[KASIR] Lelang result:', result);
                
                if (result.success) {
                    successMessages.push(`✅ Lelang: ${result.message}`);
                } else {
                    errorMessages.push(`❌ Lelang: ${result.message}`);
                }
            } catch (error) {
                console.error('[KASIR] Lelang checkout error:', error);
                errorMessages.push(`❌ Lelang: ${error.message}`);
            }
        }
        
        // Hide loading
        document.getElementById('loadingSpinner').style.display = 'none';
        
        // Tampilkan hasil
        if (successMessages.length > 0 || errorMessages.length > 0) {
            let message = '';
            
            if (successMessages.length > 0) {
                message += successMessages.join('\n') + '\n\n';
            }
            
            if (errorMessages.length > 0) {
                message += errorMessages.join('\n');
            }
            
            alert(message);
            
            // Jika ada yang berhasil, clear cart
            if (successMessages.length > 0) {
                // Hapus item yang berhasil dari cart
                const failedItems = cartItems.filter(item => {
                    if (item.mode === 'biasa' && errorMessages.some(msg => msg.includes('Biasa'))) {
                        return true;
                    }
                    if (item.mode === 'lelang' && errorMessages.some(msg => msg.includes('Lelang'))) {
                        return true;
                    }
                    return false;
                });
                
                // Update cart
                if (window.Cart) {
                    // Clear semua dulu
                    window.Cart.clear();
                    
                    // Tambahkan kembali item yang gagal
                    failedItems.forEach(item => {
                        window.Cart.add(item.sku, item.name, item.price, item.mode);
                    });
                }
                
                // Refresh display
                if (typeof updateCartDisplay === 'function') {
                    updateCartDisplay();
                }
            }
        }
        
    } catch (error) {
        console.error('[KASIR] Checkout error:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        alert(`Error: ${error.message}`);
    }
}

// Simple test function
async function simpleTestCheckout() {
    console.log('[TEST] Starting simple test');
    
    // Create test cart item
    const testItem = {
        sku: "12345",
        name: "Produk Test",
        price: 10000,
        qty: 1,
        subtotal: 10000,
        mode: 'biasa'
    };
    
    // Add to cart
    cartItems = [testItem];
    updateCartDisplay();
    
    // Try checkout
    await checkout();
}

// Add test button (temporary)
function addTestButton() {
    const testBtn = document.createElement('button');
    testBtn.className = 'btn btn-warning btn-sm mt-2';
    testBtn.innerHTML = '<i class="bi bi-bug"></i> Test Checkout';
    testBtn.onclick = simpleTestCheckout;
    document.querySelector('.card-body').appendChild(testBtn);
}

// Add test button when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(addTestButton, 1000);
});
</script>
<div class="mt-3">
    <button class="btn btn-sm btn-outline-info" onclick="testCheckout()">
        <i class="bi bi-bug"></i> Test Checkout
    </button>
</div>

<script>
// Error Handler Global
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('[KASIR ERROR]', msg, 'at', url, 'line', lineNo);
    return true; // Mencegah alert bawaan browser
};

// Initialize saat halaman load
document.addEventListener('DOMContentLoaded', function() {
    console.log('[KASIR] Page loaded');
    
    try {
        // Initialize cart
        if (window.Cart) {
            window.Cart.init();
        } else {
            console.warn('[KASIR] Cart.js not loaded yet');
            // Fallback ke localStorage langsung
            loadCartFromStorage();
        }
        
        // Set mode awal
        setMode('biasa');
        
        // Load initial products
        setTimeout(searchItem, 100);
        
    } catch (error) {
        console.error('[KASIR] Initialization error:', error);
    }
});

// Fallback function jika cart.js belum di-load
function loadCartFromStorage() {
    try {
        const savedCart = JSON.parse(localStorage.getItem('cartItems') || '[]');
        // Simpan ke variable lokal (bukan global)
        window.cartItems = savedCart;
        updateCartDisplay();
    } catch (e) {
        console.error('[KASIR] Error loading cart:', e);
        window.cartItems = [];
    }
}
</script>
{% endblock %}