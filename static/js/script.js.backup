let cart = [];

// 1. Fungsi Pencarian Produk
async function searchItem() {
    const query = document.getElementById('query').value;
    const resultsDiv = document.getElementById('searchResults');
    
    if (query.length < 1) {
        resultsDiv.innerHTML = '<div class="text-muted text-center p-3">Mulai mengetik untuk mencari...</div>';
        return;
    }

    try {
        const response = await fetch(`/api/search?q=${query}`);
        const data = await response.json();

        let html = '';
        if (data.length === 0) {
            html = '<div class="text-danger text-center p-3">Barang tidak ditemukan.</div>';
        } else {
            data.forEach(p => {
                html += `
                    <div class="product-item p-3 mb-2 rounded d-flex justify-content-between align-items-center">
                        <div>
                            <span class="d-block fw-bold text-dark">${p.Name_product}</span>
                            <small class="text-muted">SKU: ${p.no_SKU} | Stok: ${p.stok}</small>
                        </div>
                        <div class="text-end">
                            <span class="d-block fw-bold text-primary">Rp${p.Price.toLocaleString()}</span>
                            <button class="btn btn-sm btn-primary mt-1" 
                                    onclick="addToCart('${p.no_SKU}', '${p.Name_product}', ${p.Price}, ${p.stok})">
                                <i class="bi bi-plus-lg"></i> Tambah
                            </button>
                        </div>
                    </div>`;
            });
        }
        resultsDiv.innerHTML = html;
    } catch (error) {
        console.error("Search Error:", error);
    }
}

// 2. Fungsi Tambah ke Keranjang
function addToCart(sku, name, price, stock) {
    const existing = cart.find(item => item.sku === sku);
    
    if (existing) {
        if (existing.qty < stock) {
            existing.qty += 1;
        } else {
            alert("Maaf, stok tidak mencukupi!");
            return;
        }
    } else {
        if (stock > 0) {
            cart.push({ sku, name, price, qty: 1 });
        } else {
            alert("Stok barang ini kosong!");
            return;
        }
    }
    renderCart();
}

// 3. Render Keranjang
function renderCart() {
    const cartList = document.getElementById('cartList');
    const totalDisplay = document.getElementById('totalHarga');
    const cartCount = document.getElementById('cartCount');
    
    let html = '';
    let total = 0;

    cart.forEach((item, index) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        html += `
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <div style="flex: 1;">
                    <span class="fw-bold d-block">${item.name}</span>
                    <small class="text-muted">${item.qty} x Rp${item.price.toLocaleString()}</small>
                </div>
                <div class="text-end" style="min-width: 100px;">
                    <span class="d-block fw-bold text-success">Rp${subtotal.toLocaleString()}</span>
                    <i class="bi bi-trash text-danger cursor-pointer" onclick="removeFromCart(${index})" style="cursor:pointer"></i>
                </div>
            </div>`;
    });

    cartList.innerHTML = html || '<div class="text-center text-muted py-5 bg-light rounded">Belum ada item</div>';
    totalDisplay.innerText = `Rp${total.toLocaleString()}`;
    cartCount.innerText = `${cart.length} Item`;
}

// 4. Hapus Item
function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
}

// 5. Checkout
async function checkout() {
    if (cart.length === 0) {
        alert("Keranjang masih kosong!");
        return;
    }

    if (!confirm("Proses transaksi sekarang?")) return;

    try {
        const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cart })
        });

        const res = await response.json();
        if (res.success) {
            alert("Transaksi Berhasil!");
            cart = [];
            renderCart();
            document.getElementById('query').value = "";
            document.getElementById('searchResults').innerHTML = '<div class="text-muted text-center py-5 w-100"><i class="bi bi-box-seam fs-1 d-block mb-2"></i>Silakan cari barang</div>';
        } else {
            alert("Gagal: " + res.message);
        }
    } catch (e) {
        alert("Error sistem: Hubungi Admin JustCani!");
    }
}