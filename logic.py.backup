import mysql.connector
from mysql.connector import Error
import bcrypt

class Database:
    @staticmethod
    def get_conn():
        try:
            return mysql.connector.connect(
                host='localhost',
                user='root',
                password='',
                database='db_kasir1'
            )
        except Error as e:
            print(f"Gagal koneksi database: {e}")
            return None

class Inventory:
    def __init__(self, db_conn):
        self.db = db_conn

    def search_produk(self, query):
        if not self.db: return []
        cursor = self.db.cursor(dictionary=True)
        sql = "SELECT * FROM produk_biasa WHERE Name_product LIKE %s OR no_SKU = %s"
        cursor.execute(sql, (f"%{query}%", query))
        result = cursor.fetchall()
        cursor.close()
        return result

    def add_produk_baru(self, sku, name, harga, expired_date):
        if not self.db: return
        cursor = self.db.cursor()
        try:
            sql = "INSERT INTO produk_biasa (no_SKU, Name_product, Price, expired_date, stok) VALUES (%s, %s, %s, %s, 0)"
            cursor.execute(sql, (sku, name, harga, expired_date))
            self.db.commit()
        except Error as e:
            print(f"Error tambah produk: {e}")
            self.db.rollback()
        finally:
            cursor.close()

class Transaction:
    def __init__(self, db_conn):
        self.db = db_conn

    def checkout(self, items):
        if not self.db: return False, "Database tidak terhubung"
        cursor = self.db.cursor()
        try:
            for item in items:
                cursor.execute("SELECT stok FROM produk_biasa WHERE no_SKU = %s", (item['sku'],))
                result = cursor.fetchone()
                if not result or result[0] < item['qty']:
                    return False, f"Stok tidak cukup untuk SKU {item['sku']}"
            
            for item in items:
                sql = "UPDATE produk_biasa SET stok = stok - %s WHERE no_SKU = %s"
                cursor.execute(sql, (item['qty'], item['sku']))
            self.db.commit()
            return True, "Transaksi Berhasil!"
        except Error as e:
            self.db.rollback()
            return False, f"Gagal: {str(e)}"
        finally:
            cursor.close()

class CashierSystem:
    def __init__(self):
        self.db = Database.get_conn()
        self.inventory = Inventory(self.db)
        self.transaction = Transaction(self.db)
    
    @staticmethod
    def hash_password(password):
        """Hash password menggunakan bcrypt"""
        salt = bcrypt.gensalt()
        return bcrypt.hashpw(password.encode('utf-8'), salt)
    
    @staticmethod
    def check_password(hashed_password, password):
        """Verifikasi password"""
        if isinstance(hashed_password, str):
            hashed_password = hashed_password.encode('utf-8')
        return bcrypt.checkpw(password.encode('utf-8'), hashed_password)

    def login_user(self, email, password):
        if not self.db: return None
        cursor = self.db.cursor(dictionary=True)
        try:
            sql = "SELECT id, username, email, password_hash, role FROM users WHERE email = %s"
            cursor.execute(sql, (email,))
            user = cursor.fetchone()
            
            if user and self.check_password(user['password_hash'], password):
                return {
                    'id': user['id'],
                    'username': user['username'],
                    'email': user['email'],
                    'role': user['role']
                }
            return None
        except Error as e:
            print(f"Error login: {e}")
            return None
        finally:
            cursor.close()

    def register_user(self, username, email, whatsapp, password, role='kasir'):
        if not self.db: return False
        cursor = self.db.cursor()
        try:
            hashed_password = self.hash_password(password)
            
            sql = """
            INSERT INTO users (username, email, whatsapp, password_hash, role) 
            VALUES (%s, %s, %s, %s, %s)
            """
            cursor.execute(sql, (username, email, whatsapp, hashed_password, role))
            self.db.commit()
            return True
        except Error as e:
            print(f"Error register: {e}")
            self.db.rollback()
            return False
        finally:
            cursor.close()

    def close(self):
        if self.db: self.db.close()